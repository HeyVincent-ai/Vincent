generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - authenticated users who can claim and manage secrets
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  stytchUserId      String?   @unique @map("stytch_user_id")
  telegramUsername  String?   @map("telegram_username")
  telegramChatId    String?   @map("telegram_chat_id")
  stripeCustomerId  String?   @unique @map("stripe_customer_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  referralCode     String?    @unique @map("referral_code")

  dataSourceCreditUsd  Decimal  @default(10.00) @map("data_source_credit_usd") @db.Decimal(10, 2)

  secrets            Secret[]
  subscriptions      Subscription[]
  gasUsages          GasUsage[]
  monthlyGasSummaries MonthlyGasSummary[]
  auditLogs          AuditLog[]
  openclawDeployments OpenClawDeployment[]
  referralsMade       Referral[] @relation("ReferrerRelation")
  referralReceived    Referral?  @relation("ReferredRelation")
  dataSourceUsage     DataSourceUsage[]
  dataSourceCreditPurchases DataSourceCreditPurchase[]

  @@map("users")
}

// Secret types enum
enum SecretType {
  EVM_WALLET
  POLYMARKET_WALLET
  RAW_SIGNER
  API_KEY
  SSH_KEY
  OAUTH_TOKEN
  DATA_SOURCES
}

// Secret model - stores secrets with optional value (can be null for user-provided secrets)
model Secret {
  id          String      @id @default(cuid())
  userId      String?     @map("user_id")
  type        SecretType
  value       String?     // Encrypted at rest, null for user-provided secrets until set
  memo        String?     // User-friendly description
  claimToken  String?     @unique @map("claim_token")
  claimedAt   DateTime?   @map("claimed_at")
  deletedAt   DateTime?   @map("deleted_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user                      User?                        @relation(fields: [userId], references: [id])
  walletMetadata            WalletSecretMetadata?
  polymarketCredentials     PolymarketCredentials?
  polymarketWalletMetadata  PolymarketWalletMetadata?
  rawSignerMetadata         RawSignerMetadata?
  apiKeys                   ApiKey[]
  ownershipChallenges       OwnershipChallenge[]
  policies          Policy[]
  transactionLogs   TransactionLog[]
  auditLogs         AuditLog[]
  gasUsages         GasUsage[]
  dataSourceUsage   DataSourceUsage[]
  tradeRules             TradeRule[]
  tradeMonitoredPositions TradeMonitoredPosition[]

  @@map("secrets")
}

// Polymarket CLOB API credentials for EVM_WALLET secrets used with Polymarket
model PolymarketCredentials {
  id         String   @id @default(cuid())
  secretId   String   @unique @map("secret_id")
  eoaAddress String   @map("eoa_address") // EOA address used for Polymarket (not smart account)
  apiKey     String   @map("api_key")
  apiSecret  String   @map("api_secret")
  passphrase String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@map("polymarket_credentials")
}

// Polymarket wallet metadata for POLYMARKET_WALLET secrets (Gnosis Safe based)
model PolymarketWalletMetadata {
  id          String   @id @default(cuid())
  secretId    String   @unique @map("secret_id")
  eoaAddress  String   @map("eoa_address")
  safeAddress String   @map("safe_address")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@map("polymarket_wallet_metadata")
}

// Wallet-specific metadata for EVM_WALLET secrets
model WalletSecretMetadata {
  id                   String    @id @default(cuid())
  secretId             String    @unique @map("secret_id")
  smartAccountAddress  String    @map("smart_account_address")
  canTakeOwnership     Boolean   @default(false) @map("can_take_ownership")
  ownershipTransferred Boolean   @default(false) @map("ownership_transferred")
  ownerAddress         String?   @map("owner_address") // User's EOA after ownership transfer
  transferredAt        DateTime? @map("transferred_at")
  transferTxHash       String?   @map("transfer_tx_hash")
  chainsTransferred    Int[]     @default([]) @map("chains_transferred") // Snapshot of chains at ownership transfer time
  chainsUsed           Int[]     @default([]) @map("chains_used") // Track which chains have been used
  sessionKeyData       String?   @map("session_key_data")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@map("wallet_secret_metadata")
}

// Raw signer metadata - stores both Ethereum and Solana addresses and public keys
model RawSignerMetadata {
  id              String   @id @default(cuid())
  secretId        String   @unique @map("secret_id")
  ethAddress      String   @map("eth_address")
  solanaAddress   String   @map("solana_address")
  ethPublicKey    String?  @map("eth_public_key")    // Uncompressed secp256k1 public key (hex)
  solanaPublicKey String?  @map("solana_public_key") // ed25519 public key (hex)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@map("raw_signer_metadata")
}

// API Keys for agent access to secrets
model ApiKey {
  id        String    @id @default(cuid())
  secretId  String    @map("secret_id")
  keyHash   String    @map("key_hash") // bcrypt hashed, original shown only once
  name      String    // Friendly name for the key
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  secret          Secret           @relation(fields: [secretId], references: [id], onDelete: Cascade)
  transactionLogs TransactionLog[]
  auditLogs       AuditLog[]

  @@map("api_keys")
}

// Policy types enum
enum PolicyType {
  ADDRESS_ALLOWLIST
  FUNCTION_ALLOWLIST
  TOKEN_ALLOWLIST
  SPENDING_LIMIT_PER_TX
  SPENDING_LIMIT_DAILY
  SPENDING_LIMIT_WEEKLY
  REQUIRE_APPROVAL
  APPROVAL_THRESHOLD // @deprecated - use spending limit with approvalOverride instead
}

// Policies for governing secret usage
model Policy {
  id           String     @id @default(cuid())
  secretId     String     @map("secret_id")
  policyType   PolicyType @map("policy_type")
  policyConfig Json       @map("policy_config") // JSON configuration for the policy
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@map("policies")
}

// Transaction status enum
enum TransactionStatus {
  PENDING
  APPROVED
  DENIED
  EXECUTED
  FAILED
  TIMEOUT
}

// Transaction log for skill executions
model TransactionLog {
  id            String            @id @default(cuid())
  secretId      String            @map("secret_id")
  apiKeyId      String?           @map("api_key_id")
  actionType    String            @map("action_type") // e.g., "transfer", "send_transaction"
  requestData   Json              @map("request_data")
  responseData  Json?             @map("response_data")
  status        TransactionStatus @default(PENDING)
  txHash        String?           @map("tx_hash")
  approvedBy    String?           @map("approved_by") // Who approved if needed
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  secret          Secret           @relation(fields: [secretId], references: [id], onDelete: Cascade)
  apiKey          ApiKey?          @relation(fields: [apiKeyId], references: [id])
  pendingApproval PendingApproval?

  @@map("transaction_logs")
}

// Pending approvals for transactions requiring human approval
model PendingApproval {
  id                String    @id @default(cuid())
  transactionLogId  String    @unique @map("transaction_log_id")
  telegramMessageId String?   @map("telegram_message_id")
  expiresAt         DateTime  @map("expires_at")
  approved          Boolean?  // null = pending, true = approved, false = denied
  respondedAt       DateTime? @map("responded_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  transactionLog TransactionLog @relation(fields: [transactionLogId], references: [id], onDelete: Cascade)

  @@map("pending_approvals")
}

// Subscription status enum
enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

// Stripe subscription tracking
model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @map("user_id")
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  status               SubscriptionStatus
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  canceledAt           DateTime?          @map("canceled_at")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Gas usage tracking per transaction
model GasUsage {
  id              String   @id @default(cuid())
  secretId        String   @map("secret_id")
  userId          String?  @map("user_id")
  transactionHash String   @map("transaction_hash")
  chainId         Int      @map("chain_id")
  gasUsed         BigInt   @map("gas_used")
  gasPriceGwei    Decimal  @map("gas_price_gwei") @db.Decimal(20, 9)
  costUsd         Decimal  @map("cost_usd") @db.Decimal(20, 8)
  createdAt       DateTime @default(now()) @map("created_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@map("gas_usage")
}

// Monthly gas summary for billing
model MonthlyGasSummary {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  month           String   // Format: YYYY-MM
  totalCostUsd    Decimal  @map("total_cost_usd") @db.Decimal(20, 8)
  billed          Boolean  @default(false)
  stripeInvoiceId String?  @map("stripe_invoice_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@map("monthly_gas_summaries")
}

// Audit log status enum
enum AuditLogStatus {
  SUCCESS
  FAILED
  PENDING
}

// Comprehensive audit logging
model AuditLog {
  id           String         @id @default(cuid())
  secretId     String?        @map("secret_id")
  apiKeyId     String?        @map("api_key_id")
  userId       String?        @map("user_id")
  action       String         // e.g., "skill.transfer", "policy.create", "secret.claim"
  inputData    Json?          @map("input_data")
  outputData   Json?          @map("output_data")
  status       AuditLogStatus
  errorMessage String?        @map("error_message")
  ipAddress    String?        @map("ip_address")
  userAgent    String?        @map("user_agent")
  durationMs   Int?           @map("duration_ms") // Execution time in milliseconds
  createdAt    DateTime       @default(now()) @map("created_at")

  secret Secret? @relation(fields: [secretId], references: [id], onDelete: SetNull)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([secretId, createdAt])
  @@index([action, createdAt])
  @@index([status, createdAt])
  @@map("audit_logs")
}

// Ownership challenge for wallet self-custody verification
model OwnershipChallenge {
  id        String   @id @default(cuid())
  secretId  String   @map("secret_id")
  address   String   // New owner address (lowercased)
  challenge String   @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@unique([secretId, address])
  @@map("ownership_challenges")
}

// OpenClaw deployment status enum
enum OpenClawStatus {
  PENDING_PAYMENT
  PENDING
  ORDERING
  PROVISIONING
  INSTALLING
  READY
  CANCELING
  ERROR
  DESTROYING
  DESTROYED
}

// OpenClaw VPS deployment tracking
model OpenClawDeployment {
  id              String         @id @default(cuid())
  userId          String         @map("user_id")
  user            User           @relation(fields: [userId], references: [id])

  // OVH identifiers
  ovhServiceName  String?        @unique @map("ovh_service_name")
  ovhOrderId      String?        @map("ovh_order_id")
  ovhCartId       String?        @map("ovh_cart_id")

  // Instance details
  ipAddress       String?        @map("ip_address")
  hostname        String?        @map("hostname")
  accessToken     String?        @map("access_token")
  sshPrivateKey   String?        @map("ssh_private_key")  @db.Text
  sshPublicKey    String?        @map("ssh_public_key")   @db.Text

  // OpenRouter
  openRouterKeyHash String?      @map("open_router_key_hash")

  // Pre-provisioned Vincent secrets (JSON: { dataSourcesSecretId, walletSecretId, polymarketSecretId })
  vincentSecretIds   Json?        @map("vincent_secret_ids")

  // Channel configuration
  telegramConfigured Boolean      @default(false) @map("telegram_configured")

  // Status tracking
  status          OpenClawStatus @default(PENDING)
  statusMessage   String?        @map("status_message")
  provisionLog    String?        @map("provision_log") @db.Text
  provisionStage  String?        @map("provision_stage")

  // Billing
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  currentPeriodEnd     DateTime? @map("current_period_end")
  canceledAt           DateTime? @map("canceled_at")

  // Token billing (LLM credits)
  creditBalanceUsd     Decimal  @default(25.00) @map("credit_balance_usd") @db.Decimal(10, 2)
  lastKnownUsageUsd    Decimal  @default(0)     @map("last_known_usage_usd") @db.Decimal(10, 2)
  lastUsagePollAt      DateTime?                @map("last_usage_poll_at")
  creditPurchases      OpenClawCreditPurchase[]

  // Timestamps
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  readyAt         DateTime?      @map("ready_at")
  destroyedAt     DateTime?      @map("destroyed_at")

  @@index([userId])
  @@map("openclaw_deployments")
}

// Data source usage tracking per API call
model DataSourceUsage {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  secretId        String    @map("secret_id")
  apiKeyId        String?   @map("api_key_id")
  dataSource      String    @map("data_source")   // "twitter", "brave"
  endpoint        String                           // "search", "get-tweet", "web", etc.
  costUsd         Decimal   @map("cost_usd") @db.Decimal(10, 6)
  requestMetadata Json?     @map("request_metadata")
  createdAt       DateTime  @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id])
  secret Secret @relation(fields: [secretId], references: [id])

  @@index([userId, createdAt])
  @@index([secretId, createdAt])
  @@map("data_source_usage")
}

// Data source credit purchases
model DataSourceCreditPurchase {
  id                    String   @id @default(cuid())
  userId                String   @map("user_id")
  amountUsd             Decimal  @map("amount_usd") @db.Decimal(10, 2)
  stripePaymentIntentId String   @unique @map("stripe_payment_intent_id")
  createdAt             DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("data_source_credit_purchases")
}

// Pool of pre-provisioned VPSes for faster deployments
model VpsPool {
  id              String   @id @default(cuid())
  ovhServiceName  String   @unique @map("ovh_service_name")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("vps_pool")
}

// OpenClaw credit purchases for LLM token billing
model OpenClawCreditPurchase {
  id                    String   @id @default(cuid())
  deploymentId          String   @map("deployment_id")
  deployment            OpenClawDeployment @relation(fields: [deploymentId], references: [id])

  amountUsd             Decimal  @map("amount_usd") @db.Decimal(10, 2)
  stripePaymentIntentId String   @unique @map("stripe_payment_intent_id")

  createdAt             DateTime @default(now()) @map("created_at")

  @@index([deploymentId])
  @@map("openclaw_credit_purchases")
}

// Referral status enum
enum ReferralStatus {
  PENDING        // Referred user signed up, hasn't paid yet
  REWARD_PENDING // Referred user paid, but referrer has no active deployment
  FULFILLED      // $10 credit applied to referrer's deployment
}

// Referral tracking
model Referral {
  id              String         @id @default(cuid())
  referrerId      String         @map("referrer_id")
  referredUserId  String         @unique @map("referred_user_id")
  status          ReferralStatus @default(PENDING)
  rewardAmountUsd Decimal        @default(10.00) @map("reward_amount_usd") @db.Decimal(10, 2)
  deploymentId    String?        @map("deployment_id")
  fulfilledAt     DateTime?      @map("fulfilled_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  referrer     User @relation("ReferrerRelation", fields: [referrerId], references: [id])
  referredUser User @relation("ReferredRelation", fields: [referredUserId], references: [id])

  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

// ============================================================
// Trade Manager Models
// ============================================================

enum TradeRuleType {
  STOP_LOSS
  TAKE_PROFIT
  TRAILING_STOP
}

enum TradeRuleStatus {
  ACTIVE
  TRIGGERED
  CANCELED
  EXPIRED
  FAILED
}

enum TradeRuleEventType {
  RULE_CREATED
  RULE_EVALUATED
  RULE_TRIGGERED
  RULE_FAILED
  RULE_CANCELED
  RULE_TRAILING_UPDATED
  ACTION_ATTEMPT
  ACTION_EXECUTED
  ACTION_FAILED
}

model TradeRule {
  id              String          @id @default(cuid())
  secretId        String          @map("secret_id")
  ruleType        TradeRuleType   @map("rule_type")
  marketId        String          @map("market_id")
  marketSlug      String?         @map("market_slug")
  tokenId         String          @map("token_id")
  side            String          @default("BUY")
  triggerPrice    Float           @map("trigger_price")
  trailingPercent Float?          @map("trailing_percent")
  action          String          // JSON: { type: "SELL_ALL" } or { type: "SELL_PARTIAL", amount: N }
  status          TradeRuleStatus @default(ACTIVE)
  triggeredAt     DateTime?       @map("triggered_at")
  triggerTxHash   String?         @map("trigger_tx_hash")
  errorMessage    String?         @map("error_message")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  secret Secret         @relation(fields: [secretId], references: [id], onDelete: Cascade)
  events TradeRuleEvent[]

  @@index([secretId, status])
  @@index([status])
  @@index([tokenId])
  @@map("trade_rules")
}

model TradeMonitoredPosition {
  id            String   @id @default(cuid())
  secretId      String   @map("secret_id")
  marketId      String   @map("market_id")
  marketSlug    String?  @map("market_slug")
  tokenId       String   @map("token_id")
  side          String
  quantity      Float
  avgEntryPrice Float?   @map("avg_entry_price")
  currentPrice  Float    @map("current_price")
  marketTitle   String?  @map("market_title")
  outcome       String?
  endDate       String?  @map("end_date")
  redeemable    Boolean  @default(false)
  lastUpdatedAt DateTime @map("last_updated_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)

  @@unique([secretId, marketId, tokenId, side])
  @@map("trade_monitored_positions")
}

model TradeRuleEvent {
  id        String             @id @default(cuid())
  ruleId    String             @map("rule_id")
  eventType TradeRuleEventType @map("event_type")
  eventData Json               @map("event_data")
  createdAt DateTime           @default(now()) @map("created_at")

  rule TradeRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId, createdAt])
  @@map("trade_rule_events")
}
