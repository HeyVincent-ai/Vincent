name: sentry-triage

on:
  schedule:
    # periodic triage every 3 hours
    - cron: '15 */3 * * *'
    # daily morning summary at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    env:
      SENTRY_CREDENTIALS_PATH: ./.sentry-credentials.json
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.SENTRY_SUMMARY_TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.SENTRY_SUMMARY_TELEGRAM_CHAT_ID }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build temporary Sentry credentials file
        env:
          SENTRY_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG_SLUG: ${{ secrets.SENTRY_ORG_SLUG }}
          SENTRY_PROJECT_SLUGS: ${{ secrets.SENTRY_PROJECT_SLUGS }}
        run: |
          if [ -z "$SENTRY_TOKEN" ] || [ -z "$SENTRY_ORG_SLUG" ] || [ -z "$SENTRY_PROJECT_SLUGS" ]; then
            echo "Missing one or more required Sentry secrets: SENTRY_AUTH_TOKEN, SENTRY_ORG_SLUG, SENTRY_PROJECT_SLUGS"
            exit 1
          fi

          node -e '
            const fs = require("fs");
            const token = process.env.SENTRY_TOKEN;
            const orgSlug = process.env.SENTRY_ORG_SLUG;
            const projectSlugs = process.env.SENTRY_PROJECT_SLUGS.split(",").map(s => s.trim()).filter(Boolean);
            fs.writeFileSync(".sentry-credentials.json", JSON.stringify({ token, orgSlug, projectSlugs, baseUrl: "https://sentry.io" }, null, 2));
          '

      - name: Run triage
        id: triage
        run: |
          SEND_TELEGRAM=false
          if [ "${{ github.event.schedule }}" = "0 9 * * *" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SEND_TELEGRAM=true
          fi

          npm run sentry:triage -- \
            --hours 24 \
            --limit 25 \
            --syncGithubIssues true \
            --minConfidence 0.85 \
            --sendTelegram "$SEND_TELEGRAM"

      - name: Upload triage reports
        uses: actions/upload-artifact@v4
        with:
          name: sentry-triage-reports
          path: reports/
          if-no-files-found: ignore
