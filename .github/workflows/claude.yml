name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, labeled]

# Write permissions are required so Claude can commit fixes and push to PR branches.
# Triggers are restricted to repo collaborators only (see author_association checks below).
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  claude:
    # Only trigger for repo members/collaborators mentioning @claude
    if: |
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)
      ) ||
      (
        github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)
      ) ||
      (
        github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.review.author_association)
      ) ||
      (
        github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'claude'
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: false
          claude_args: '--max-turns 20 --allowedTools "Bash(npm test),Bash(npm run lint),Bash(npm run lint:fix),Bash(npx tsc --noEmit),Bash(npx vitest run),Bash(npm run build),Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr),Bash(gh issue),Read,Write,Edit,Glob,Grep"'

  # Auto-fix Codex review comments - triggers when Codex posts a review
  auto-fix-codex:
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'chatgpt-codex-connector[bot]' &&
      github.event.review.state == 'COMMENTED'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Get review comments
        id: get_comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_ID="${{ github.event.review.id }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Fetch the review comments
          COMMENTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews/$REVIEW_ID/comments" \
            --jq '.[] | "**\(.path):\(.position)** - \(.body)\n"')

          # Also get the main review body if it exists
          REVIEW_BODY="${{ github.event.review.body }}"

          # Combine them
          if [ -n "$REVIEW_BODY" ]; then
            FULL_REVIEW="## Codex Review Summary\n\n$REVIEW_BODY\n\n## Specific Comments\n\n$COMMENTS"
          else
            FULL_REVIEW="## Codex Review Comments\n\n$COMMENTS"
          fi

          echo "review_content<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Codex has posted a code review with the following feedback:

            ${{ steps.get_comments.outputs.review_content }}

            Please:
            1. Read and understand each review comment
            2. Make the necessary fixes to address the feedback
            3. Run relevant tests and checks to verify your fixes
            4. Commit and push your changes with a descriptive message
            5. Reply to the review with a summary of what you fixed

            Use `gh pr comment ${{ github.event.pull_request.number }} --body "your summary"` to post your response.
          claude_args: '--max-turns 30 --allowedTools "Bash(npm test),Bash(npm run lint),Bash(npm run lint:fix),Bash(npx tsc --noEmit),Bash(npx vitest run),Bash(npm run build),Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr comment),Bash(gh pr),Read,Write,Edit,Glob,Grep"'

  # Auto-fix GitHub Copilot review comments - triggers when Copilot posts a review
  auto-fix-copilot:
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'copilot-pull-request-reviewer[bot]' &&
      github.event.review.state == 'COMMENTED'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Get review comments
        id: get_comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_ID="${{ github.event.review.id }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Fetch the review comments
          COMMENTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews/$REVIEW_ID/comments" \
            --jq '.[] | "**\(.path):\(.line)** - \(.body)\n"')

          # Also get the main review body if it exists
          REVIEW_BODY="${{ github.event.review.body }}"

          # Combine them
          if [ -n "$REVIEW_BODY" ]; then
            FULL_REVIEW="## GitHub Copilot Review Summary\n\n$REVIEW_BODY\n\n## Specific Comments\n\n$COMMENTS"
          else
            FULL_REVIEW="## GitHub Copilot Review Comments\n\n$COMMENTS"
          fi

          echo "review_content<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            GitHub Copilot has posted a code review with the following feedback:

            ${{ steps.get_comments.outputs.review_content }}

            Please:
            1. Read and understand each review comment
            2. Make the necessary fixes to address the feedback
            3. Run relevant tests and checks to verify your fixes
            4. Commit and push your changes with a descriptive message
            5. Reply to the review with a summary of what you fixed

            Use `gh pr comment ${{ github.event.pull_request.number }} --body "your summary"` to post your response.
          claude_args: '--max-turns 30 --allowedTools "Bash(npm test),Bash(npm run lint),Bash(npm run lint:fix),Bash(npx tsc --noEmit),Bash(npx vitest run),Bash(npm run build),Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr comment),Bash(gh pr),Read,Write,Edit,Glob,Grep"'

  # Auto-fix CI failures - triggers on any PR when a collaborator comments "@claude fix ci"
  auto-fix-ci:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude fix ci') &&
      contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            CI has failed on this PR. Run the tests with `npm test`, the linter
            with `npm run lint`, and type-check with `npx tsc --noEmit`.
            Identify the failures and fix them. Make minimal, targeted changes.
            After fixing, re-run the checks to verify they pass.
          claude_args: '--max-turns 25 --allowedTools "Bash(npm test),Bash(npm run lint),Bash(npm run lint:fix),Bash(npx tsc --noEmit),Bash(npx vitest run),Bash(npm run build),Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Read,Write,Edit,Glob,Grep"'
